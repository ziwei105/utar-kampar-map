<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Parking Slot Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 600px; }
    .slot-marker {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 1px solid #333;
      text-align: center;
      line-height: 20px;
      color: white;
      font-weight: bold;
      font-size: 12px;
    }
    .vacant { background-color: green; }
    .occupied { background-color: red; }
  </style>
</head>
<body>
  <h1>UTAR Kampar Parking Slots</h1>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Initialize the map centered around your polygon
    const map = L.map('map').setView([4.3410, 101.1365], 18);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 22,
    }).addTo(map);

    // Your GeoJSON polygon
    const polygonGeoJSON = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "properties": { "Name": "Polygon 1" },
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [101.1367119, 4.3409922],
                [101.1362774, 4.3412275],
                [101.1359743, 4.3407408],
                [101.1364008, 4.3405509],
                [101.1367119, 4.3409922]
              ]
            ]
          }
        }
      ]
    };

    // Add polygon to map
    const polygonLayer = L.geoJSON(polygonGeoJSON).addTo(map);

    // Get polygon bounds to distribute slots
    const bounds = polygonLayer.getBounds();
    const latStep = (bounds.getNorth() - bounds.getSouth()) / 10;
    const lngStep = (bounds.getEast() - bounds.getWest()) / 5;

    const totalSlots = 50;
    let slotCount = 0;
    const slotMarkers = [];

    for (let i = 0; i < 10; i++) {
      for (let j = 0; j < 5; j++) {
        if (slotCount >= totalSlots) break;
        const lat = bounds.getSouth() + i * latStep + latStep / 2;
        const lng = bounds.getWest() + j * lngStep + lngStep / 2;

        // Create a div icon
        const slotDiv = L.divIcon({
          className: 'slot-marker vacant',
          html: `A${slotCount + 1}`
        });

        const marker = L.marker([lat, lng], { icon: slotDiv }).addTo(map);
        slotMarkers.push({ marker, slotId: `A${slotCount + 1}` });

        slotCount++;
      }
    }

    // Fetch parking data from API and update markers
    async function fetchParkingData() {
      try {
        const response = await fetch("https://of3greluu9.execute-api.ap-southeast-1.amazonaws.com/slots");
        const data = await response.json();

        data.forEach(item => {
          const slot = slotMarkers.find(s => s.slotId === item.slot_id);
          if (slot) {
            const className = item.status.toLowerCase() === 'occupied' ? 'slot-marker occupied' : 'slot-marker vacant';
            slot.marker.setIcon(L.divIcon({ className, html: slot.slotId }));
          }
        });
      } catch (err) {
        console.error(err);
      }
    }

    fetchParkingData();
    setInterval(fetchParkingData, 5000);
  </script>
</body>
</html>
